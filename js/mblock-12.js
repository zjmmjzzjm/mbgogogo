(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{806:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=A(a(28)),n=A(a(195)),r=A(a(477)),s=A(a(22)),u=A(a(27)),o=A(a(77)),i=A(a(80)),c=A(a(164)),d=A(a(40)),f=A(a(38)),p=A(a(23)),m=A(a(25)),h=A(a(9)),E=A(a(2)),v=A(a(7)),g=A(a(5)),U=A(a(6)),C=A(a(12)),x=A(a(1)),S=a(14),T=A(a(16)),k=A(a(92)),O=A(a(48)),b=A(a(15)),w=a(18),I=A(a(487));function A(e){return e&&e.__esModule?e:{default:e}}var N=function(e){function t(e){var a=this;(0,E.default)(this,t);var l,n=(0,g.default)(this,(t.__proto__||(0,h.default)(t)).call(this,e));return n.state={showUpload:!0,fileList:[],percent:!1,statusClassName:"",progressStatus:"active"},n.handleException=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(clearInterval(n.watcher),"exception"!==n.state.progressStatus&&n.state.percent||99999===e.code){(0,m.default)(p.default.mark(function e(){var t;return p.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.uploadName||!n.uploadId){e.next=12;break}return e.prev=1,e.next=4,k.default.OssService.abortUpload(n.uploadName,n.uploadId);case 4:(t=e.sent)&&204===t.res.status&&(n.resetUploadOpt(),n.setState({percent:!1}),n.props.setUploading(!1)),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),n.onError();case 12:case"end":return e.stop()}},e,a,[[1,8]])}))(),n.onError(),n.props.form.setFieldsValue({attachment:"",suffix:""});var t=n.props.intlr.messages;f.default.warn(t["NETWORK.ERR.MSG"])}},n.resetUploadOpt=function(){n.uploadName="",n.uploadId="",n.interrupt=!1},n.onBeforeUpload=(l=(0,m.default)(p.default.mark(function e(t,l){var r,s,u,o,i,c,m,h;return p.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.interrupt){e.next=2;break}return e.abrupt("return");case 2:if(!(t.size>10485760)){e.next=7;break}return r=n.props.intlr.messages,n.props.form.setFieldsValue({attachment:"",suffix:""}),f.default.warn(r["FEEDBACK.FORM.ATTACHMENT.UPLOAD.MAXSIZE"]),e.abrupt("return",d.default.reject());case 7:return n.setState({fileList:l,progressStatus:"success"}),l.length>0&&(n.setState({showUpload:!1}),n.props.setUploading(!0)),e.prev=9,e.next=12,k.default.OssService.uploadAttachToken({_HEADER_:{utoken:O.default.get(b.default.USER_ACCESS_TOKEN_KEY),pid:3}});case 12:if(!(s=e.sent)){e.next=21;break}return u=function(e,t){return n.lastUploadTime=(new Date).getTime(),n.uploadName=t&&t.name,n.uploadId=t&&t.uploadId,n.setState({percent:0===e?1:Math.floor(100*e)}),function(e){return e()}},o=function(){var e=(new Date).getTime();n.lastUploadTime&&e-n.lastUploadTime>1e4&&n.handleException()},n.watcher=setInterval(o.bind(n),1e3),e.next=19,k.default.OssService.uploadAttachment(s,t,{timeout:5e3,progress:u.bind(n)});case 19:(i=e.sent)&&i.res&&200===i.res.status&&(clearInterval(n.watcher),n.resetUploadOpt(),c="http://"+s.bucket+"."+s.region+".aliyuncs.com/"+s.commitId,m=n.props.form.setFieldsValue,h=(0,w.getFileSuffix)(t.name),m({attachment:c,suffix:h=h?"."+h:""}),n.props.setUploading(!1),n.setState({statusClassName:"done",progressStatus:"success",percent:!1}));case 21:return e.abrupt("return",d.default.reject());case 24:if(e.prev=24,e.t0=e.catch(9),!e.t0||0!==e.t0.status||"cancel"!==e.t0.name){e.next=29;break}return e.abrupt("return");case 29:return n.handleException(e.t0),e.abrupt("return",d.default.reject());case 31:case"end":return e.stop()}},e,a,[[9,24]])})),function(e,t){return l.apply(this,arguments)}),n.onRemove=(0,m.default)(p.default.mark(function e(){var t;return p.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(clearInterval(n.watcher),!n.interrupt){e.next=3;break}return e.abrupt("return");case 3:if(!n.uploadName||!n.uploadId){e.next=17;break}return n.interrupt=!0,e.prev=5,e.next=8,k.default.OssService.abortUpload(n.uploadName,n.uploadId);case 8:(t=e.sent)&&204===t.res.status&&(n.resetUploadOpt(),n.setState({percent:!1}),n.props.setUploading(!1)),e.next=17;break;case 12:e.prev=12,e.t0=e.catch(5),n.resetUploadOpt(),n.handleException();case 17:(0,n.props.form.setFieldsValue)({attachment:"",suffix:""}),n.setState({showUpload:!0,statusClassName:"",fileList:[],percent:!1});case 20:case"end":return e.stop()}},e,a,[[5,12]])})),n.resetUploadOpt(),n}return(0,U.default)(t,e),(0,v.default)(t,[{key:"componentWillUnmount",value:function(){clearInterval(this.watcher)}},{key:"onError",value:function(){this.resetUploadOpt(),this.setState({statusClassName:"error",progressStatus:"exception"}),this.props.setUploading(!1)}},{key:"render",value:function(){var e=this,t=this.props,a=t.data,l=t.form,d=t.intlr.messages,f=l.getFieldDecorator,p=this.state,m=p.showUpload,h=p.fileList,E=p.percent,v=p.statusClassName,g=p.progressStatus,U=d["FEEDBACK.PROFESSION.LIST"];return x.default.createElement(i.default,null,x.default.createElement(i.default.Item,null,f("profession",{initialValue:a.profession})(x.default.createElement(c.default,{mode:"combobox",placeholder:d["FEEDBACK.FORM.PROFESSION"]},U.map(function(e,t){return x.default.createElement(c.default.Option,{value:e,key:t},e)})))),x.default.createElement(i.default.Item,null,f("contact",{initialValue:a.contact})(x.default.createElement(o.default,{placeholder:d["FEEDBACK.FORM.CONTACT"],maxLength:"100"}))),x.default.createElement(i.default.Item,{colon:!1},f("call",{initialValue:a.call})(x.default.createElement(o.default,{placeholder:d["FEEDBACK.FORM.CALL"],maxLength:"100"}))),x.default.createElement(i.default.Item,null,f("description",{initialValue:a.description,rules:[{required:!0,message:d["FEEDBACK.FORM.DESCRIPTION.REQUIRE"]}]})(x.default.createElement(o.default.TextArea,{placeholder:d["FEEDBACK.FORM.DESCRIPTION"],autosize:!1,style:{resize:"none",height:"6rem"}}))),x.default.createElement(i.default.Item,null,f("suffix",{initialValue:a.suffix})(x.default.createElement(o.default,{hidden:!0}))),x.default.createElement(i.default.Item,null,f("attachment",{initialValue:a.attachment})(x.default.createElement("div",null,x.default.createElement(r.default,{name:"file",style:{width:"100%"},showUploadList:!1,beforeUpload:this.onBeforeUpload,onRemove:this.onRemove},m&&x.default.createElement(s.default,{style:{width:"100%"},className:"btn-sm-font text-overflow",type:"primary",ghost:!0},x.default.createElement(u.default,{type:"upload"}),d["FEEDBACK.FORM.ATTACHMENT.UPLOAD.TEXT"])),h.map(function(t){return x.default.createElement("div",{className:"file-list-item "+v,key:t.uid},x.default.createElement("div",{className:"flex-row jcc"},x.default.createElement("span",{className:"col auto-width-col",style:{maxWidth:"14rem"}},x.default.createElement(u.default,{className:"mr",type:"paper-clip"}),t.name),x.default.createElement("a",{className:"remove-btn",onClick:e.onRemove},x.default.createElement(u.default,{className:"ml",type:"close"}))),E?x.default.createElement(n.default,{style:{marginTop:12,marginBottom:0},percent:E,status:g,showInfo:!1}):null)})))))}}]),t}(x.default.Component),F=i.default.create()(N),y=function(e){function t(e){(0,E.default)(this,t);var a=(0,g.default)(this,(t.__proto__||(0,h.default)(t)).call(this,e));return a.handleCancel=function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]||a.props.cache(a.formRef.props.form.getFieldsValue()),setTimeout(function(){T.default.push((0,w.parseRoute)("/"))},0)},a.handleOk=function(){a.formRef.props.form.validateFields(function(e,t){if(!e){var l=a.props,n=l.intlr,r=l.add,s=l.cache;C.default.has(t,"suffix")&&C.default.isEmpty(t.suffix)&&(t.attachment=""),r(t,function(){a.handleCancel(!0),f.default.success(n.messages["FEEDBACK.ADD.SUCCESS"]),s({profession:t.profession,contact:t.contact,call:t.call})},function(){f.default.error(n.messages["FEEDBACK.ADD.FAILED"]),s(t)})}})},a.setUploading=function(e){a.setState({isUploading:e})},a.state={isUploading:!1},a}return(0,U.default)(t,e),(0,v.default)(t,[{key:"render",value:function(){var e=this,t=this.props,a=t.intlr,n=t.feedback,r=this.state.isUploading,u=a.messages,o=n.cacheData,i=n.status===b.default.REQUEST_STATUS.PENDING;return x.default.createElement(l.default,{visible:!0,width:400,title:u["FEEDBACK.MODAL.TITLE"],maskClosable:!1,onCancel:function(){return e.handleCancel()},footer:x.default.createElement("div",{style:{textAlign:"center"}},x.default.createElement(s.default,{type:"primary",ghost:!0,key:"cancel",onClick:this.handleCancel},u["BUTTON.CANCEL.TEXT"]),x.default.createElement(s.default,{type:"primary",key:"ok",style:{marginLeft:"8px"},loading:i,disabled:i||r,onClick:this.handleOk},u["BUTTON.SUBMIT.TEXT"]))},x.default.createElement(F,{intlr:a,wrappedComponentRef:function(t){return e.formRef=t},data:o,setUploading:this.setUploading}))}}]),t}(x.default.Component);t.default=(0,S.connect)(function(e){return{intlr:e.intlr,qiniu:e.qiniu,feedback:e.feedback}},function(e){return{add:function(t,a,l){return e(I.default.addFeedback(t,a,l))},cache:function(t){return e(I.default.cache(t))}}})(y)}}]);